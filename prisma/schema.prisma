// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
}

enum BookingStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
  EXPIRED
  PENDING_PAYMENT // reservado para fase Mercado Pago
}

enum PaymentProvider {
  MERCADOPAGO
}

enum PaymentMethod {
  PIX
}

enum PaymentIntent {
  SIGNAL // cobrar apenas o sinal (signalAmountCents)
  TOTAL  // cobrar o total (totalPriceCents)
}

enum PlanType {
  BASIC
  PRO
  BUSINESS
}

enum LimitKey {
  SERVICES_ACTIVE_MAX
  LINKS_ACTIVE_MAX
  BOOKINGS_PER_MONTH_MAX
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
}

model Tenant {
  id                   String   @id @default(uuid())
  name                 String
  slug                 String   @unique
  timezone             String   @default("America/Fortaleza")
  slotIntervalMinutes  Int      @default(15)
  signalPercentDefault Int      @default(0)

  // --- Billing / Plano ---
  planType             PlanType           @default(BASIC)
  subscriptionStatus   SubscriptionStatus @default(TRIALING)
  currentPeriodStartAt DateTime?
  currentPeriodEndAt   DateTime?

  // ids externos (Stripe futuramente)
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique

  // --- Tema (claro/escuro + custom por tenant) ---
  theme                Json?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  users                User[]
  services             Service[]
  businessHours        BusinessHour[]
  scheduleBlocks       ScheduleBlock[]
  customers            Customer[]
  bookings             Booking[]
  bookingLinks         BookingLink[]
  payments             Payment[]

  tenantLimitOverride  TenantLimitOverride[]
  tenantMonthlyUsage   TenantMonthlyUsage[]
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(ADMIN)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Service {
  id                    String   @id @default(uuid())
  tenantId              String
  tenant                Tenant   @relation(fields: [tenantId], references: [id])
  name                  String
  durationMinutes       Int
  priceCents            Int
  signalPercentOverride Int?
  active                Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  bookings              Booking[]
  bookingLinks          BookingLink[]
}

model BusinessHour {
  id       String  @id @default(uuid())
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id])
  weekday  Int     // 0=Sunday ... 6=Saturday (Luxon)
  startTime String // "09:00"
  endTime   String // "18:00"
  active   Boolean @default(true)

  @@index([tenantId, weekday])
}

model ScheduleBlock {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  startAt   DateTime
  endAt     DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@index([tenantId, startAt, endAt])
}

model Customer {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  phone     String
  email     String?
  createdAt DateTime @default(now())

  bookings  Booking[]

  @@index([tenantId, phone])
}

model Booking {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id])
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  code    String        @unique
  startAt DateTime
  endAt   DateTime
  status  BookingStatus @default(CONFIRMED)

  totalPriceCents       Int
  signalPercentApplied  Int
  signalAmountCents     Int
  expiresAt             DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[]

  @@index([tenantId, startAt, endAt])
  @@index([tenantId, status])
}

model BookingLink {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  token  String  @unique
  active Boolean @default(true)

  // opcional: se quiser restringir o link a um serviço específico
  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId, active])
}

model Payment {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id])

  provider  PaymentProvider
  method    PaymentMethod
  intent    PaymentIntent

  amountCents Int

  // Status vindo do Mercado Pago (pending/approved/rejected/cancelled...)
  status       String
  statusDetail String?

  // IDs externos
  mpPaymentId        String? @unique
  mpIdempotencyKey   String  @unique
  mpExternalRef      String?

  // PIX payload
  qrCode       String?
  qrCodeBase64 String?
  ticketUrl    String?
  expiresAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, bookingId])
  @@index([tenantId, status])
}

model WebhookEvent {
  id         String   @id @default(uuid())
  provider   PaymentProvider
  eventKey   String   @unique
  payload    Json
  receivedAt DateTime @default(now())
}

model PlanLimit {
  id       String   @id @default(uuid())
  planType PlanType
  key      LimitKey
  valueInt Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planType, key])
}

model TenantLimitOverride {
  id       String   @id @default(uuid())
  tenantId String
  tenant   Tenant   @relation(fields: [tenantId], references: [id])

  key      LimitKey
  deltaInt Int

  // Para boost mensal de BOOKINGS_PER_MONTH_MAX, preencha "YYYY-MM" (ex: "2026-02")
  yearMonth String?

  // Para boosts genéricos por tempo (ex: +links por 30 dias)
  expiresAt DateTime?

  reason   String?
  source   String?
  refId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, key, expiresAt])
  @@index([tenantId, key, yearMonth])
}

model TenantMonthlyUsage {
  id              String   @id @default(uuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id])

  yearMonth        String   // "2026-02"
  bookingsCreated  Int      @default(0)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([tenantId, yearMonth])
  @@index([tenantId, yearMonth])
}